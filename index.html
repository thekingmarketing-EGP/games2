<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ff6b12">
<title>ÙƒØ´Ø±ÙŠ Ø§Ù„ÙˆØ²ÙŠØ± | Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø©</title>
<style>
    :root { --primary: #ff6b12; --danger: #ff4757; --accent: #f1c40f; }
    
    * { 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent; 
        touch-action: none; 
        user-select: none; 
    }
    
    body { 
        margin:0; padding: 0;
        overflow:hidden; 
        background: #111; 
        font-family: 'Arial', sans-serif; 
        width: 100vw; height: 100vh;
        overscroll-behavior: none;
    }
    
    #game-container { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background-image: url('Ø§Ø®ØªØ±Ø§Ù‚.jpg'); 
        background-size: 100% 100%; 
        background-repeat: no-repeat; 
        background-position: center;
        background-color: #ff9100;
        overflow:hidden;
    }

    #ui { 
        position:absolute; top: env(safe-area-inset-top, 10px); left:0; width:100%; 
        padding: 15px 20px; 
        display: flex; justify-content: space-between; 
        z-index: 50; pointer-events: none;
    }
    
    .stat-box {
        background: rgba(0, 0, 0, 0.6);
        padding: 8px 15px; border-radius: 20px;
        border: 2px solid var(--accent); color: white;
        font-size: 1.1rem; font-weight: bold;
        display: flex; align-items: center; gap: 5px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .stat-value { color: var(--accent); }

    /* Ø²Ø± Ø§Ù„ØµÙˆØª */
    #sound-btn {
        position: absolute; bottom: 30px; left: 20px;
        background: rgba(0,0,0,0.6); color: var(--accent);
        border: 2px solid var(--accent); border-radius: 50%;
        width: 50px; height: 50px; font-size: 1.5rem;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 150; /* ÙÙˆÙ‚ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù„Ù…Ø³ */
        backdrop-filter: blur(5px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    .player { 
        position:absolute; width: 70px; height: 50px; 
        background-image: url('Ø§Ù„Ø·Ø¨Ù‚.png'); background-size: contain;
        background-repeat: no-repeat; background-position: center;
        z-index: 10;
        will-change: transform, top, left; 
    }

    .platform { 
        position:absolute; width:100px; height:15px; 
        background: linear-gradient(to bottom, #eee, #ccc); 
        border-radius:10px; 
        box-shadow: 0 5px 10px rgba(0,0,0,0.5); 
        border: 1px solid #999;
    }
    .platform.moving { background: linear-gradient(to bottom, #f1c40f, #d4ac0d); border-color: #b7950b; }

    /* Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù„Ù…Ø³ */
    #touch-left { position: absolute; left: 0; top: 0; width: 50%; height: 100%; z-index: 20; }
    #touch-right { position: absolute; right: 0; top: 0; width: 50%; height: 100%; z-index: 20; }

    .screen { 
        position:absolute; inset:0; 
        display:flex; flex-direction:column; justify-content:center; align-items:center; 
        z-index: 100; text-align: center; padding: 20px;
        transition: opacity 0.3s;
    }
    
    #startScreen {
        background-image: url('U.jpg'); background-size: 100% 100%;
        background-repeat: no-repeat; background-position: center;
    }
    #startScreen::before { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.6); z-index: -1; }
    
    #gameOverScreen { background: rgba(0,0,0,0.9); display: none; }

    .btn { 
        padding: 18px 50px; font-size: 22px; cursor: pointer; 
        background: var(--primary); border: none; color: white; 
        border-radius: 50px; font-weight: bold;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        border: 2px solid rgba(255,255,255,0.2);
        transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.95); }

    /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ */
    .live-counter {
        margin-top: 25px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 25px;
        border-radius: 12px;
        border: 2px solid var(--accent);
        text-align: center;
        animation: pulseBorder 2s infinite;
        backdrop-filter: blur(5px);
        width: 80%; max-width: 300px;
    }
    .live-counter span { display: block; color: #ddd; font-size: 0.9rem; margin-bottom: 5px; }
    .live-counter strong { color: var(--accent); font-size: 1.8rem; font-family: monospace; letter-spacing: 2px; }
    @keyframes pulseBorder {
        0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); }
        100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    h1 { text-shadow: 2px 2px 0 #000; margin: 0 0 10px 0; }
    p { text-shadow: 1px 1px 0 #000; font-weight: bold; font-size: 1.1rem; }

</style>
</head>
<body>

<div id="game-container">
    <div id="ui">
        <div class="stat-box">Ø§Ù„Ø·Ù„Ø¨: <span id="scoreVal" class="stat-value">0</span></div>
        <div class="stat-box">ğŸ”¥ <span id="speedVal" class="stat-value">Ù‡Ø§Ø¯ÙŠØ©</span></div>
    </div>

    <div id="sound-btn" onclick="toggleMute()">ğŸ”Š</div>

    <div id="player" class="player"></div>

    <div id="touch-left"></div>
    <div id="touch-right"></div>

    <div id="startScreen" class="screen">
        <h1 style="color:var(--accent); font-size: 3rem;">ÙƒØ´Ø±ÙŠ Ø§Ù„ÙˆØ²ÙŠØ±</h1>
        <p style="margin-bottom:30px;">Ø§Ù„Ù…Ø³ ÙŠÙ…ÙŠÙ† Ø£Ùˆ Ø´Ù…Ø§Ù„ Ù„Ù„ØªØ­Ø±Ùƒ<br>Ø§Ù„Ø·Ø¨Ù‚ Ø¨ÙŠÙ†Ø· Ù„ÙˆØ­Ø¯Ù‡!</p>
        
        <button id="startBtn" class="btn">Ø§ÙØªØ­ Ø§Ù„Ù…Ø­Ù„ ğŸ¥„</button>

        <div class="live-counter">
            <span>Ø£ÙƒÙŠÙ„Ø© Ø§Ù„ÙƒØ´Ø±ÙŠ Ø§Ù„Ø¢Ù†</span>
            <strong id="visitorCount">1,000</strong>
        </div>
    </div>

    <div id="gameOverScreen" class="screen">
        <h1 style="color:var(--danger); font-size: 2.5rem;">Ø§Ù„ØµÙ„ØµØ© Ø´Ø§Ø·Øª!</h1>
        <p style="font-size: 1.5rem;">Ø§Ù„Ø§Ø³ÙƒÙˆØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="finalScore" style="color:var(--accent); font-size: 2.5rem; display:block;">0</span></p>
        <button id="restartBtn" class="btn">Ø§ØºØ±Ù Ù…Ù† Ø¬Ø¯ÙŠØ¯ ğŸ²</button>
    </div>
</div>

<script>
// --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª ---
const audio = {
    bgm: new Audio('bgm.mp3'),
    jump: new Audio('jump.mp3'),
    dead: new Audio('dead.mp3'),
    click: new Audio('click.mp3')
};

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
audio.bgm.loop = true;
audio.bgm.volume = 0.4; // ØµÙˆØª Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù‡Ø§Ø¯ÙŠ Ø´ÙˆÙŠØ©
let isMuted = false;

function playSound(name) {
    if (isMuted) return;
    if (audio[name]) {
        audio[name].currentTime = 0; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØµÙˆØª Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        audio[name].play().catch(() => {}); // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ØªØµÙØ­
    }
}

function toggleMute() {
    isMuted = !isMuted;
    const btn = document.getElementById('sound-btn');
    if (isMuted) {
        btn.innerText = 'ğŸ”‡';
        audio.bgm.pause();
    } else {
        btn.innerText = 'ğŸ”Š';
        if (state.gameActive) audio.bgm.play().catch(()=>{});
    }
}

// --- ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯ ---
(function initCounter() {
    const countEl = document.getElementById('visitorCount');
    if(!countEl) return;
    let currentCount = localStorage.getItem('koshary_visits'); 
    if (!currentCount) { currentCount = 1000; } 
    else { currentCount = parseInt(currentCount); }

    function updateDisplay() { countEl.innerText = currentCount.toLocaleString('en-US'); }
    updateDisplay();

    setInterval(() => {
        const increase = Math.floor(Math.random() * 3) + 1;
        currentCount += increase;
        localStorage.setItem('koshary_visits', currentCount);
        updateDisplay();
    }, 3000);
})();

// --- Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
const game = document.getElementById('game-container');
const playerEl = document.getElementById('player');
const scoreVal = document.getElementById('scoreVal');
const speedVal = document.getElementById('speedVal');

let config = {
    gravity: 0.4,
    jumpForce: -13, 
    moveSpeed: 7,
    friction: 0.85,
    baseScrollSpeed: 1.5,
    difficultyScale: 0.0005
};

let state = {
    w: window.innerWidth,
    h: window.innerHeight,
    x: window.innerWidth / 2, 
    y: window.innerHeight / 2,
    vx: 0, vy: 0,
    score: 0,
    gameActive: false,
    scrollSpeed: config.baseScrollSpeed,
    platforms: [],
    movingLeft: false,
    movingRight: false
};

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¹Ù†Ø¯ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø©
window.addEventListener('resize', () => {
    state.w = window.innerWidth;
    state.h = window.innerHeight;
});

function initPlatforms() {
    state.platforms = [];
    document.querySelectorAll('.platform').forEach(p => p.remove());
    
    // Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØªØ­Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
    createPlatform(state.w / 2 - 100, state.h - 150, 200, 'normal'); 
    
    // Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ù…Ù†ØµØ§Øª
    let currentY = state.h - 150;
    while (currentY > 0) {
        currentY -= 120; // Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ù†ØµØ§Øª
        spawnPlatform(currentY);
    }
}

function spawnPlatform(yPos) {
    let type = 'normal';
    if (state.score >= 300) {
        if (Math.random() > 0.75) type = 'moving';
    }
    // Ù…ÙƒØ§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¯Ø§Ø®Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©
    let pWidth = 100;
    let maxX = state.w - pWidth;
    let xPos = Math.random() * maxX;
    createPlatform(xPos, yPos, pWidth, type);
}

function createPlatform(x, y, width, type) {
    const el = document.createElement('div');
    el.className = 'platform ' + type;
    el.style.width = width + 'px';
    game.appendChild(el);
    state.platforms.push({ el, x, y, w: width, h: 15, type, dir: Math.random() > 0.5 ? 1 : -1 });
}

// Ø§Ù„ØªØ­ÙƒÙ…
const handleStartLeft = (e) => { if(e.preventDefault) e.preventDefault(); state.movingLeft = true; };
const handleEndLeft = (e) => { state.movingLeft = false; };
const handleStartRight = (e) => { if(e.preventDefault) e.preventDefault(); state.movingRight = true; };
const handleEndRight = (e) => { state.movingRight = false; };

const leftZone = document.getElementById('touch-left');
const rightZone = document.getElementById('touch-right');

leftZone.addEventListener('touchstart', handleStartLeft, {passive: false});
leftZone.addEventListener('touchend', handleEndLeft);
leftZone.addEventListener('mousedown', handleStartLeft);
leftZone.addEventListener('mouseup', handleEndLeft);

rightZone.addEventListener('touchstart', handleStartRight, {passive: false});
rightZone.addEventListener('touchend', handleEndRight);
rightZone.addEventListener('mousedown', handleStartRight);
rightZone.addEventListener('mouseup', handleEndRight);

// Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
window.onkeydown = e => {
    if(e.code === 'ArrowLeft') state.movingLeft = true;
    if(e.code === 'ArrowRight') state.movingRight = true;
};
window.onkeyup = e => {
    if(e.code === 'ArrowLeft') state.movingLeft = false;
    if(e.code === 'ArrowRight') state.movingRight = false;
};

document.getElementById('startBtn').onclick = startGame;
document.getElementById('restartBtn').onclick = () => {
    playSound('click');
    document.getElementById('gameOverScreen').style.display = 'none';
    startGame();
};

function startGame() {
    playSound('click');
    playSound('bgm'); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰

    document.getElementById('startScreen').style.display = 'none';
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    state.x = state.w / 2 - 35;
    state.y = state.h - 250;
    state.vx = 0; state.vy = 0;
    state.score = 0;
    state.scrollSpeed = config.baseScrollSpeed;
    scoreVal.innerText = "0";
    speedVal.innerText = "Ù‡Ø§Ø¯ÙŠØ©";
    state.gameActive = true;
    
    initPlatforms();
    requestAnimationFrame(loop);
}

function loop() {
    if (!state.gameActive) return;

    // 1. Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø£ÙÙ‚ÙŠØ©
    if (state.movingLeft) state.vx = -config.moveSpeed;
    else if (state.movingRight) state.vx = config.moveSpeed;
    else state.vx *= config.friction;
    
    state.x += state.vx;

    // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© (Loop Around)
    if (state.x < -40) state.x = state.w - 30;
    else if (state.x > state.w - 30) state.x = -40;

    // 2. Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ø±Ø£Ø³ÙŠØ© (Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡)
    state.vy += config.gravity;
    state.y += state.vy;
    
    // 3. Ø­Ø±ÙƒØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    let cameraShift = 0;
    if (state.y < state.h * 0.4) {
        cameraShift = (state.h * 0.4) - state.y;
        state.y = state.h * 0.4; // ØªØ«Ø¨ÙŠØª Ø§Ù„Ù„Ø§Ø¹Ø¨
    }
    
    let totalScroll = state.scrollSpeed + (cameraShift * 0.15); 
    state.scrollSpeed += config.difficultyScale;

    if (cameraShift <= 0) {
        state.y += state.scrollSpeed;
    }

    playerEl.style.transform = `rotate(${state.vx * 2}deg)`;

    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØµØ§Øª
    state.platforms.forEach((p, index) => {
        p.y += totalScroll; 
        
        if (p.type === 'moving') {
            p.x += p.dir * 2.5;
            if (p.x <= 0 || p.x + p.w >= state.w) p.dir *= -1;
        }

        // Ø§Ù„ØªØµØ§Ø¯Ù…
        if (state.vy > 0 && 
            state.x + 50 > p.x && state.x + 20 < p.x + p.w && 
            state.y + 45 >= p.y && state.y + 45 <= p.y + 25) {
            
            playSound('jump'); // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ù†Ø·Ø©
            state.vy = config.jumpForce;
            state.y = p.y - 48; 
        }
        
        p.el.style.left = p.x + 'px';
        p.el.style.top = p.y + 'px';
    });

    // 5. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ§Øª
    for (let i = state.platforms.length - 1; i >= 0; i--) {
        if (state.platforms[i].y > state.h) {
            state.platforms[i].el.remove();
            state.platforms.splice(i, 1);
            spawnPlatform(-30);
            state.score += 10;
            scoreVal.innerText = state.score;

            if(state.score > 500) speedVal.innerText = "Ù…ÙˆÙ„Ø¹Ø© ğŸ”¥";
            else if(state.score > 200) speedVal.innerText = "Ø¹Ø§Ù„ÙŠØ© â™¨ï¸";
        }
    }

    // 6. Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
    playerEl.style.left = state.x + 'px';
    playerEl.style.top = state.y + 'px';

    // 7. Ø´Ø±Ø· Ø§Ù„Ø®Ø³Ø§Ø±Ø©
    if (state.y > state.h) {
        state.gameActive = false;
        
        audio.bgm.pause(); // ÙˆÙ‚Ù Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
        audio.bgm.currentTime = 0;
        playSound('dead'); // ØµÙˆØª Ø§Ù„Ø®Ø³Ø§Ø±Ø©

        document.getElementById('gameOverScreen').style.display = 'flex';
        document.getElementById('finalScore').innerText = state.score;
    } else {
        requestAnimationFrame(loop);
    }
}
</script>
</body>
</html>
